"use strict";(()=>{var e={};e.id=217,e.ids=[217],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},9651:(e,r,s)=>{s.r(r),s.d(r,{originalPathname:()=>j,patchFetch:()=>v,requestAsyncStorage:()=>x,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g});var t={};s.r(t),s.d(t,{GET:()=>m,POST:()=>y});var n=s(9303),o=s(8716),a=s(3131),i=s(7070),u=s(728),c=s(5456),p=s(5630),d=s(9489);let l=p.Ry({content:p.Z_().min(1,"Message content is required"),propertyId:p.Z_().min(1,"Property ID is required")});async function m(e){try{let r=e.cookies.get("token")?.value;if(!r)return i.NextResponse.json({success:!1,error:"Authentication required"},{status:401});let s=(0,c.WX)(r);if(!s)return i.NextResponse.json({success:!1,error:"Invalid token"},{status:401});let{searchParams:t}=new URL(e.url),n=t.get("propertyId");if(!n)return i.NextResponse.json({success:!1,error:"Property ID is required"},{status:400});let o=await u._.property.findUnique({where:{id:n}});if(!o)return i.NextResponse.json({success:!1,error:"Property not found"},{status:404});let a=await u._.message.findFirst({where:{propertyId:n,senderId:s.userId}});if(o.ownerId!==s.userId&&!a)return i.NextResponse.json({success:!1,error:"Unauthorized"},{status:403});let p=await u._.message.findMany({where:{propertyId:n},include:{sender:{select:{id:!0,name:!0,avatar:!0}}},orderBy:{createdAt:"asc"}});return i.NextResponse.json({success:!0,data:p})}catch(e){return console.error("Get messages error:",e),i.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function y(e){try{let r=e.cookies.get("token")?.value;if(!r)return i.NextResponse.json({success:!1,error:"Authentication required"},{status:401});let s=(0,c.WX)(r);if(!s)return i.NextResponse.json({success:!1,error:"Invalid token"},{status:401});let t=await e.json(),n=l.parse(t);if(!await u._.property.findUnique({where:{id:n.propertyId}}))return i.NextResponse.json({success:!1,error:"Property not found"},{status:404});let o=await u._.message.create({data:{content:n.content,propertyId:n.propertyId,senderId:s.userId},include:{sender:{select:{id:!0,name:!0,avatar:!0}},property:{select:{id:!0,title:!0}}}});return i.NextResponse.json({success:!0,data:o,message:"Message sent successfully"})}catch(e){if(console.error("Send message error:",e),e instanceof d.j)return i.NextResponse.json({success:!1,error:e.issues[0]?.message||"Validation error"},{status:400});return i.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}let f=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/messages/route",pathname:"/api/messages",filename:"route",bundlePath:"app/api/messages/route"},resolvedPagePath:"C:\\Users\\HP\\Downloads\\task_project\\project\\src\\app\\api\\messages\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:x,staticGenerationAsyncStorage:g,serverHooks:h}=f,j="/api/messages/route";function v(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}},5456:(e,r,s)=>{s.d(r,{Oe:()=>c,RA:()=>p,WX:()=>d,c_:()=>u});var t=s(1482),n=s.n(t),o=s(2023),a=s.n(o);let i=process.env.JWT_SECRET||"fallback-secret-key",u=async e=>a().hash(e,12),c=async(e,r)=>a().compare(e,r),p=e=>n().sign(e,i,{expiresIn:"7d"}),d=e=>{try{return n().verify(e,i)}catch(e){return null}}},728:(e,r,s)=>{s.d(r,{_:()=>n});let t=require("@prisma/client"),n=globalThis.prisma??new t.PrismaClient}};var r=require("../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[276,39],()=>s(9651));module.exports=t})();